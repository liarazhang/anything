#include<reg51.h>
#include <intrins.h>
#define uchar unsigned char
#define uint unsigned int
uchar data v=3;			     //电机转速0~5
uchar data zhuan=0;			 //转弯标志
uchar data t=0;				 //计时参数	
sbit IN1 =P1^3;
sbit IN2=P1^5;
sbit IN3=P1^2;
sbit IN4=P1^0;
sbit ENA=P1^4;
sbit ENB=P1^1;			 




void Timer1() interrupt 3
{
	TH1=0XFC;	//给定时器赋初值，定时1ms
	TL1=0X18;
		t++;						 //每一毫秒t2加一
	if(t==6)t=0;				 //六毫秒为一周期为电机和数码管延时
	if(P3&0X01)zhuan=2;			 //左侧探头探测到黑线
	if(P3&0X10)zhuan=1;			 //右侧探头探测到黑线
}

void stop()
{
	IN1=0; 
	IN2=0;
	IN3=0;
	IN4=0;
	ENA=0;
	ENB=0;
}		
void qianjin()
{
if(t<=v)
{
	IN1=0;
	IN2=1;
	IN3=1;
	IN4=0;
	ENA=1;
	ENB=1;
	}
	else stop();
}		
void you()
{
if(t<=v)
{
	IN1=0;
	IN2=1;
	IN3=1;
	IN4=0;
	ENA=0;
	ENB=1;
		}
	else stop();
}	
void zuo()
{
if(t<=v)
{
	IN1=0;
	IN2=1;
	IN3=0;
	IN4=0;
	ENA=1;
	ENB=0;	
	}
	else stop();
}	
void youyuan()
{	 if(t<=v)
{
	IN1=1;
	IN2=0;
	IN3=1;
	IN4=0;
	ENA=1;
	ENB=1; 	}
	else stop();
}	
void zuoyuan()
{	  if(t<=v)	{
	IN1=0;
	IN2=1;
	IN3=0;
	IN4=1;
	ENA=1;
	ENB=1;	}
	else stop();
}	

void main()
{
TMOD|=0X10;//选择为定时器1模式，工作方式1，仅用TR1打开启动。

	TH1=0XFC;	//给定时器赋初值，定时1ms
	TL1=0X18;	
	ET1=1;//打开定时器1中断允许
	EA=1;//打开总中断
	TR1=1;//打开定时器			
    while(1)															   
	{	 
	if(P3^4==0&&P3^3==0&&P3^2==0&&P3^1==1&&P3^0==0)	you();   //you 右边内侧探头探测到黑线
	if(P3^4==0&&P3^3==0&&P3^2==0&&P3^1==1&&P3^0==1)	you();   // 右边两个探头探测到黑线
	if(P3^4==0&&P3^3==0&&P3^2==1&&P3^1==1&&P3^0==0) you();   // 中间和右边内侧探头探测到黑线
	if(P3^4==0&&P3^3==0&&P3^2==1&&P3^1==1&&P3^0==1) you();   // 右边三个探头探测到黑线
	if(P3^4==1&&P3^3==0&&P3^2==0&&P3^1==1&&P3^0==0) you();   // 左边外侧和右边内侧探头探测到黑线
	if(P3^4==1&&P3^3==0&&P3^2==1&&P3^1==1&&P3^0==0) you();   // 左边外侧，中间和右边内侧探头探测到黑线
	if(P3^4==0&&P3^3==1&&P3^2==0&&P3^1==0&&P3^0==0) zuo();   //zuo 左边内侧探头探测到黑线
	if(P3^4==0&&P3^3==1&&P3^2==0&&P3^1==0&&P3^0==1) zuo();   // 左边内侧和右边外侧探头探测到黑线
	if(P3^4==0&&P3^3==1&&P3^2==1&&P3^1==0&&P3^0==0) zuo();   // 左边内侧和中间探头探测到黑线
	if(P3^4==0&&P3^3==1&&P3^2==1&&P3^1==0&&P3^0==1) zuo();   // 左边内侧，中间和右边外侧探头探测到黑线
	if(P3^4==1&&P3^3==1&&P3^2==0&&P3^1==0&&P3^0==0) zuo();   // 左边两个探头探测到黑线
	if(P3^4==1&&P3^3==1&&P3^2==1&&P3^1==0&&P3^0==0) zuo();   // 左边三个探头探测到黑线
	if(P3^4==1&&P3^3==1&&P3^2==1&&P3^1==1&&P3^0==1) stop();   //stop 所有探头都探测到黑线 
	if(P3^4==0&&P3^3==0&&P3^2==0&&P3^1==0&&P3^0==1) youyuan();   //youyuan 右边外侧探头探测到黑线
	if(P3^4==1&&P3^3==0&&P3^2==0&&P3^1==0&&P3^0==0) zuoyuan();   // 左边外侧探头探测到黑线
	if(P3^4==0&&P3^3==0&&P3^2==0&&P3^1==0&&P3^0==0&&zhuan==1) zuoyuan();   		 //	探测不到黑线
	if(P3^4==0&&P3^3==0&&P3^2==0&&P3^1==0&&P3^0==0&&zhuan==2) youyuan();   		   
	else qianjin();	
	}
}