#include<reg51.h>
#include <intrins.h>
#define uchar unsigned char
#define uint unsigned int
uchar data v=4;			     //电机转速0~5
uchar data zhuan=0;			 //转弯标志
uchar data t=0;				 //计时参数	
sbit IN1 =P1^3;
sbit IN2=P1^5;
sbit IN3=P1^2;
sbit IN4=P1^0;
sbit ENA=P1^4;
sbit ENB=P1^1;			 




void Timer1() interrupt 3
{
	TH1=0XFC;	//给定时器赋初值，定时1ms
	TL1=0X18;
		t++;						 //每一毫秒t2加一
	if(t==6)t=0;				 //六毫秒为一周期为电机和数码管延时
	if(P3&0X01)zhuan=2;			 //左侧探头探测到黑线
	if(P3&0X10)zhuan=1;			 //右侧探头探测到黑线
}

void stop()
{
	IN1=0; 
	IN2=0;
	IN3=0;
	IN4=0;
	ENA=0;
	ENB=0;
}		
void qianjin()
{
if(t<=(v+1))
{
	IN1=0;
	IN2=1;
	IN3=1;
	IN4=0;
	ENA=1;
	ENB=1;
	}
	else stop();
}		
void you()
{
if(t<=v)
{
	IN1=0;
	IN2=1;
	IN3=1;
	IN4=0;
	ENA=0;
	ENB=1;
		}
	else stop();
}	
void zuo()
{
if(t<=v)
{
	IN1=0;
	IN2=1;
	IN3=0;
	IN4=0;
	ENA=1;
	ENB=0;	
	}
	else stop();
}	
void youyuan()
{	 if(t<=v)
{
	IN1=1;
	IN2=0;
	IN3=1;
	IN4=0;
	ENA=1;
	ENB=1; 	}
	else stop();
}	
void zuoyuan()
{	  if(t<=v)	{
	IN1=0;
	IN2=1;
	IN3=0;
	IN4=1;
	ENA=1;
	ENB=1;	}
	else stop();
}	

void main()
{
TMOD|=0X10;//选择为定时器1模式，工作方式1，仅用TR1打开启动。

	TH1=0XFC;	//给定时器赋初值，定时1ms
	TL1=0X18;	
	ET1=1;//打开定时器1中断允许
	EA=1;//打开总中断
	TR1=1;//打开定时器			
    while(1)															   
	{	  if(P3==0XE2||P3==0XE3||P3==0XE6||P3==0XE7||P3==0XF2||P3==0XFC)you();//右转
		else if(P3==0XE6||P3==0XE8||P3==0XE9||P3==0XEC||P3==0XED||P3==0XF8)zuo();//左转
		else if(P3==0XF0)zuoyuan();         //向左原地转弯
		else if(P3==0XE1)youyuan();         //向右原地转弯
		else if(P3==0XFF)stop();        //停止
		else if(P3==0XE0&&zhuan==1)zuoyuan();//如果之前左侧探头检测到轨道则向左原地转弯
		else if(P3==0XE0&&zhuan==2)youyuan();//如果之前右侧探头检测到轨道则向右原地转弯
		else qianjin();                     //前进
	/*if(P3^4==0,P3^3==0,P3^2==0,P3^1==1,P3^0==0)	you();   //you 右边内侧探头探测到黑线
	if(P3^4==0,P3^3==0,P3^2==0,P3^1==1,P3^0==1)	you();   // 右边两个探头探测到黑线
	if(P3^4==0,P3^3==0,P3^2==1,P3^1==1,P3^0==0) you();   // 中间和右边内侧探头探测到黑线
	if(P3^4==0,P3^3==0,P3^2==1,P3^1==1,P3^0==1) you();   // 右边三个探头探测到黑线
	if(P3^4==1,P3^3==0,P3^2==0,P3^1==1,P3^0==0) you();   // 左边外侧和右边内侧探头探测到黑线
	if(P3^4==1,P3^3==0,P3^2==1,P3^1==1,P3^0==0) you();   // 左边外侧，中间和右边内侧探头探测到黑线
	if(P3^4==0,P3^3==1,P3^2==0,P3^1==0,P3^0==0) zuo();   //zuo 左边内侧探头探测到黑线
	if(P3^4==0,P3^3==1,P3^2==0,P3^1==0,P3^0==1) zuo();   // 左边内侧和右边外侧探头探测到黑线
	if(P3^4==0,P3^3==1,P3^2==1,P3^1==0,P3^0==0) zuo();   // 左边内侧和中间探头探测到黑线
	if(P3^4==0,P3^3==1,P3^2==1,P3^1==0,P3^0==1) zuo();   // 左边内侧，中间和右边外侧探头探测到黑线
	if(P3^4==1,P3^3==1,P3^2==0,P3^1==0,P3^0==0) zuo();   // 左边两个探头探测到黑线
	if(P3^4==1,P3^3==1,P3^2==1,P3^1==0,P3^0==0) zuo();   // 左边三个探头探测到黑线
	if(P3^4==1,P3^3==1,P3^2==1,P3^1==1,P3^0==1) stop();   //stop 所有探头都探测到黑线 
	if(P3^4==0,P3^3==0,P3^2==0,P3^1==0,P3^0==1) youyuan();   //youyuan 右边外侧探头探测到黑线
	if(P3^4==1,P3^3==0,P3^2==0,P3^1==0,P3^0==0) zuoyuan();   // 左边外侧探头探测到黑线
	if(P3^4==0,P3^3==0,P3^2==0,P3^1==0,P3^0==0&&zhuan==1) zuoyuan();   		 //	探测不到黑线
	if(P3^4==0,P3^3==0,P3^2==0,P3^1==0,P3^0==0&&zhuan==2) youyuan();   		   
	else qianjin();	*/
	}
}
/*******************************************************************************************************/
// 空    空    空  /左外  左内   中   右内  右外 十六进          探测情况					  小车运动情况
//P3.7  P3.6  P3.5 /P3.4  P3.3  P3.2  P3.1  P3.0  制码
// 1-----1-----1----/0-----0-----0-----0-----0-----E0-----探测不到黑线---------------------------原地左转或右转
// 1-----1-----1----/0-----0-----0-----0-----1-----E1-----右边外侧探头探测到黑线-----------------原地右转
// 1-----1-----1----/0-----0-----0-----1-----0-----E2-----右边内侧探头探测到黑线-----------------右转
// 1-----1-----1----/0-----0-----0-----1-----1-----E3-----右边两个探头探测到黑线-----------------右转
// 1-----1-----1----/0-----0-----1-----0-----0-----E4-----中间探头探测到黑线---------------------前进
// 1-----1-----1----/0-----0-----1-----0-----1-----E5-----中间和右边外侧探头探测到黑线-----------前进
// 1-----1-----1----/0-----0-----1-----1-----0-----E6-----中间和右边内侧探头探测到黑线-----------右转
// 1-----1-----1----/0-----0-----1-----1-----1-----E7-----右边三个探头探测到黑线-----------------右转
// 1-----1-----1----/0-----1-----0-----0-----0-----E8-----左边内侧探头探测到黑线-----------------左转
// 1-----1-----1----/0-----1-----0-----0-----1-----E9-----左边内侧和右边外侧探头探测到黑线-------左转
// 1-----1-----1----/0-----1-----0-----1-----0-----EA-----左边内侧和右边内侧探头探测到黑线-------前进
// 1-----1-----1----/0-----1-----0-----1-----1-----EB-----左边内侧和右边两个探头探测到黑线-------前进
// 1-----1-----1----/0-----1-----1-----0-----0-----EC-----左边内侧和中间探头探测到黑线-----------左转
// 1-----1-----1----/0-----1-----1-----0-----1-----ED-----左边内侧，中间和右边外侧探头探测到黑线-左转
// 1-----1-----1----/0-----1-----1-----1-----0-----EE-----中间三个探头探测到黑线-----------------前进
// 1-----1-----1----/0-----1-----1-----1-----1-----EF-----右侧四个探头探测到黑线-----------------前进
// 1-----1-----1----/1-----0-----0-----0-----0-----F0-----左边外侧探头探测到黑线-----------------原地左转
// 1-----1-----1----/1-----0-----0-----0-----1-----F1-----左右两边外侧探头探测到黑线-------------前进
// 1-----1-----1----/1-----0-----0-----1-----0-----F2-----左边外侧和右边内侧探头探测到黑线-------右转
// 1-----1-----1----/1-----0-----0-----1-----1-----F3-----左边外侧和右边两个探头探测到黑线-------前进
// 1-----1-----1----/1-----0-----1-----0-----0-----F4-----左边外侧和中间探头探测到黑线-----------前进
// 1-----1-----1----/1-----0-----1-----0-----1-----F5-----左右两边外侧和中间探头探测到黑线-------前进
// 1-----1-----1----/1-----0-----1-----1-----0-----F6-----左边外侧，中间和右边内侧探头探测到黑线-右转
// 1-----1-----1----/1-----0-----1-----1-----1-----F7-----左边外侧和右边三个探头探测到黑线-------前进
// 1-----1-----1----/1-----1-----0-----0-----0-----F8-----左边两个探头探测到黑线-----------------左转
// 1-----1-----1----/1-----1-----0-----0-----1-----F9-----左边两个和右边外侧探头探测到黑线-------前进
// 1-----1-----1----/1-----1-----0-----1-----0-----FA-----左边两个和右边内侧探头探测到黑线-------前进
// 1-----1-----1----/1-----1-----0-----1-----1-----FB-----左右两边内侧和外侧探头探测到黑线-------前进
// 1-----1-----1----/1-----1-----1-----0-----0-----FC-----左边三个探头探测到黑线-----------------左转
// 1-----1-----1----/1-----1-----1-----0-----1-----FD-----左边三个和右边外侧探头探测到黑线-------前进
// 1-----1-----1----/1-----1-----1-----1-----0-----FE-----左边三个和右边内侧探头探测到黑线-------前进
// 1-----1-----1----/1-----1-----1-----1-----1-----FF-----所有探头都探测到黑线-------------------停止
/*******************************************************************************************************/
//                右侧电机          左侧电机	 
//归零  测试 /IN2   ENA   IN1  /IN3   ENB   IN4	 十六进	       两侧电机转动情况			     小车运动情况
//P1.7  P1.6 /P1.5  P1.4  P1.3 /P1.2  P1.1  P1.0  制码
// 1-----1----/1-----1-----0----/1-----1-----0-----F6-----左右电机同时正转-----------------------前进
// 1-----1----/1-----0-----0----/1-----1-----0-----C6-----左侧电机正转右侧电机不转---------------右转
// 1-----1----/1-----1-----0----/0-----0-----0-----F0-----右侧电机正转左侧电机不转---------------左转
// 1-----1----/0-----0-----0----/0-----0-----0-----C0-----左右电机都不转-------------------------停止
// 1-----1----/1-----1-----0----/0-----1-----1-----F3-----右侧点紧正转左侧电机反转---------------原地左转
// 1-----1----/0-----1-----1----/1-----1-----0-----DE-----右侧电机反转左侧电机正转---------------原地右转